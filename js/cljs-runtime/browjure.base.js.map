{"version":3,"sources":["browjure/base.cljs"],"mappings":"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","names":["js/browjure","js/browjure.base","js/browjure.base.router_","browjure.base/router_","cljs.core.atom","browjure.base/stop-router!","temp__5735__auto__","cljs.core/deref","stop-f","browjure.base/?csrf-token","el","js/document","map__83658","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","cljs.core.get","packer","taoensso.sente.packers.transit.get_transit_packer","chsk","ch-recv","send-fn","state","taoensso.sente.make_channel_socket_client_BANG_","browjure.base/chsk","browjure.base/ch-chsk","browjure.base/chsk-send!","browjure.base/chsk-state","G__83662","props__82830__auto__","maybe-ref__82831__auto__","vec__83663","helix.core/extract-cljs-props","map__83666","cljs.core.nth","goog/DEBUG","G__83689","goog.object/set","browjure.base/control-component","type","path","value","style","onChange","on-change","sci.core.eval_string","cljs.core.pr_str","js/console.log","helix.core/get-react","obj83670","helix.impl.props.primitive_obj","obj83679","obj83681","obj83686","obj83688","values","browjure.state/use-path-sub","G__83668","js/Error","iter__4529__auto__","s__83672","cljs.core/LazySeq","cljs.core/seq","cljs.core/chunked-seq?","c__4527__auto__","size__4528__auto__","cljs.core/count","b__83674","cljs.core/chunk-buffer","i__83673","vec__83675","cljs.core/-nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__83671","cljs.core/chunk-rest","vec__83682","cljs.core/first","cljs.core/cons","cljs.core/rest","control-name","control-val","e","new-values","cljs.core.assoc","browjure.state/set-path-value","browjure.base/hiccup-registry","browjure.base/window-resolve","symbol","p1__83690#","p2__83691#","cljs.core.reduce","js/window","cljs.core.conj","clojure.string.split","clojure.string/replace","cljs.core/namespace","cljs.core/name","browjure.base/handle-command","command","cljs.core._EQ_","G__83694","cljs.core.swap_BANG_","cljs.core/merge","id","or__4126__auto__","js/setTimeout","fexpr__83695","react-componentized","p1__83692#","clojure.walk/postwalk","cljs.core/vector?","make-component","cljs.core.into","cljs.core.concat","G__83696","cljs.core/second","cljs.core.drop","hiccup","p1__83693#","component","helix.core/$","vec__83697","seq__83698","first__83699","cljs.core/next","_","element","props","G__83700","cljs.core/clj->js","fexpr__83701","browjure.base/connected","browjure.base/handler","msg","cljs.core/reset!","cljs.core.not_EQ_","vec__83702","vec__83705","sente-event","browjure-event","lib-event","browjure.base/start-router!","taoensso.sente/start-client-chsk-router!","cljs.core/not","js/fetch","response","number-of-commands","cljs.core.doall","cljs.core.map","i","p1__83708#","command-str","cognitect.transit/read","cognitect.transit.reader","cljs.core.range","cljs.core/chunk-first"],"sourcesContent":["(ns browjure.base\n  (:require\n   [browjure.state :as st :refer [use-path-sub set-path-value]]\n   [taoensso.sente  :as sente :refer (cb-success?)]\n   [taoensso.sente.packers.transit  :as sente-transit]\n   [cognitect.transit :as transit]\n   [react :as react]\n   [helix.core :refer [$ defnc]]\n   [sci.core :as sci]))\n\n(defonce router_ (atom nil))\n\n(defn stop-router! [] (when-let [stop-f @router_] (stop-f)))\n\n(def ?csrf-token\n  (when-let [el (.getElementById js/document \"sente-csrf-token\")]\n    (.getAttribute el \"data-csrf-token\")))\n\n(let [packer (sente-transit/get-transit-packer)\n      {:keys [chsk ch-recv send-fn state]}\n      (sente/make-channel-socket-client!\n       \"/chsk\" ; Must match server Ring routing URL\n       ?csrf-token\n       {:type   :ws\n        :csrf-token ?csrf-token\n        :packer packer})]\n\n  (def chsk       chsk)\n  (def ch-chsk    ch-recv) ; ChannelSocket's receive channel\n  (def chsk-send! send-fn) ; ChannelSocket's send API fn\n  (def chsk-state state)   ; Watchable, read-only atom\n  )\n\n(defnc control-component [{:keys [type path value style onChange]}]\n  (let [on-change (sci/eval-string\n                  (pr-str (aget onChange \"rep\"))\n                  {:bindings {'js/console.log js/console.log\n                              'js/document    js/document}\n                   :classes {:allow :all}})\n        values    (use-path-sub path value)]\n    (case type\n      \"edn-multi-checkbox\"\n      ($ :div\n         {:style style}\n         (for [[control-name control-val] values]\n           ($ :label\n              {:key control-name} control-name\n              ($ :input\n                 {:type \"checkbox\"\n                  :checked control-val\n                  :onChange (fn [e]\n                              (let [new-values (assoc values control-name (.-checked (.-target e)))]\n                                (set-path-value path new-values)\n                                (on-change new-values)))})))))))\n\n(def hiccup-registry\n  (atom {:browjure/control 'browjure.base/control-component}))\n\n(defn window-resolve [symbol]\n  (reduce #(aget %1 %2)\n          js/window\n          (conj (clojure.string/split (clojure.string/replace (namespace symbol) \"-\" \"_\")\n                                      \".\")\n                (clojure.string/replace (name symbol) \"-\" \"_\"))))\n\n(defn handle-command [command]\n  (cond\n    (= :register-plugin (:type command))\n    (do (.append (.-head js/document)\n                 (doto (.createElement js/document \"script\")\n                   (.setAttribute \"type\" \"text/javascript\")\n                   (.setAttribute \"src\" (-> command :payload :base-path))))\n        (swap! hiccup-registry merge (-> command :payload :sablono :hiccup-tag->factory-symbol))\n        (let [id (or (:namespace (:payload command)) (name (:id command)))]\n          (js/setTimeout #(do (js/console.log \"calling base handler with register plugin command\" id command)\n                              ((aget (aget (aget js/window (clojure.string/replace id \"-\" \"_\")) \"base\") \"handler\") command))\n                         3000)))\n    (= :view-sablono (:type command))\n    (let [react-componentized\n          (clojure.walk/postwalk\n           #(cond\n              (and (vector? %)\n                   (= :react-fn-component (first %)))\n              (let [make-component (window-resolve 'clj-material-ui.base/make-component)]\n                (into [] (concat [:built-react-fn-component\n                                  (make-component (second %))]\n                                 (drop 2 %))))\n              :else %)\n           command)\n          hiccup\n          (clojure.walk/postwalk\n           #(cond\n              (and (vector? %)\n                   (get @hiccup-registry (first %)))\n              (let [component (window-resolve (get @hiccup-registry (first %)))]\n                (if (.-displayName component)\n                  (apply $ component (rest %))\n                  (apply (window-resolve (get @hiccup-registry (first %)))\n                         (rest %))))\n              (and (vector? %)\n                   (= (first %) :built-react-fn-component))\n              (let [[_ element & props] %]\n                (element (clj->js (first props))))\n              :else %)\n           react-componentized)]\n      (apply (window-resolve 'clj-sablono.base/handler) [hiccup]))\n    (= :set-path-value (:type command))\n    (set-path-value (-> command :payload :path) (-> command :payload :value))\n    :else\n    (let [id (name (:id command))]\n      ((aget (aget (aget js/window (clojure.string/replace id \"-\" \"_\")) \"base\") \"handler\") command))))\n\n(def connected (atom false))\n\n(defn handler [msg]\n  (reset! connected true)\n  (when (and (= :chsk/recv (first (:event msg)))\n             (not= :chsk/ws-ping (first (second (:event msg)))))\n    (let [[sente-event [browjure-event lib-event]] (:event msg)]\n      (js/console.log  @hiccup-registry)\n      (js/console.log \"event type\" (= :view-sablono (:type lib-event)) (:type lib-event) lib-event)\n      (when (= browjure-event :event/echo) (handle-command lib-event)))))\n\n(defn start-router! []\n  (stop-router!)\n  (reset! router_\n          (sente/start-client-chsk-router!\n           ch-chsk handler)))\n\n(start-router!)\n\n(js/setTimeout\n (fn []\n   ;;when not connected in 5 seconds assume offline usage\n   (when (not @connected)\n     (.then (js/fetch \"commands.json\")\n            (fn [response]\n              (.then (.json response)\n                     (fn [number-of-commands]\n                       (doall (map (fn [i] (.then (js/fetch (str \"command-\" i \".json\"))\n                                                  #(.then (.text %)\n                                                          (fn [command-str]\n                                                            (handle-command\n                                                             (transit/read\n                                                              (transit/reader :json)\n                                                              command-str))))))\n                                   (range number-of-commands)))))))))\n 5000)\n"]}