shadow$provide.module$node_modules$$deck_DOT_gl$core$dist$es5$lib$deck_picker=function(global,require,module,exports){global=require("module$node_modules$$babel$runtime$helpers$interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0});exports["default"]=void 0;var _defineProperty2=global(require("module$node_modules$$babel$runtime$helpers$defineProperty")),_classCallCheck2=global(require("module$node_modules$$babel$runtime$helpers$classCallCheck")),_createClass2=global(require("module$node_modules$$babel$runtime$helpers$createClass")),
_core=require("module$node_modules$$luma_DOT_gl$core$dist$es5$index"),_assert=global(require("module$node_modules$$deck_DOT_gl$core$dist$es5$utils$assert")),_log=global(require("module$node_modules$$deck_DOT_gl$core$dist$es5$utils$log")),_pickLayersPass=global(require("module$node_modules$$deck_DOT_gl$core$dist$es5$passes$pick_layers_pass")),_queryObject=require("module$node_modules$$deck_DOT_gl$core$dist$es5$lib$picking$query_object"),_pickInfo=require("module$node_modules$$deck_DOT_gl$core$dist$es5$lib$picking$pick_info");
require=function(){function DeckPicker(gl){(0,_classCallCheck2["default"])(this,DeckPicker);this.gl=gl;this.pickingFBO=null;this.pickLayersPass=new _pickLayersPass["default"](gl);this.layerFilter=null;this.lastPickedInfo={index:-1,layerId:null,info:null};this._onError=null}(0,_createClass2["default"])(DeckPicker,[{key:"setProps",value:function(props){"layerFilter"in props&&(this.layerFilter=props.layerFilter);"onError"in props&&(this._onError=props.onError)}},{key:"finalize",value:function(){if(this.pickingFBO)this.pickingFBO["delete"]();
this.depthFBO&&(this.depthFBO.color["delete"](),this.depthFBO["delete"]())}},{key:"pickObject",value:function(opts){return this._pickClosestObject(opts)}},{key:"pickObjects",value:function(opts){return this._pickVisibleObjects(opts)}},{key:"getLastPickedObject",value:function(_ref){var x=_ref.x,y=_ref.y,layers=_ref.layers,viewports=_ref.viewports,lastPickedInfo=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.lastPickedInfo.info,lastPickedLayerId=lastPickedInfo&&lastPickedInfo.layer&&lastPickedInfo.layer.id;
layers=lastPickedLayerId?layers.find(function(l){return l.id===lastPickedLayerId}):null;viewports=viewports[0]&&viewports[0].unproject([x,y]);x={x:x,y:y,coordinate:viewports,lngLat:viewports,layer:layers};return layers?Object.assign({},lastPickedInfo,x):Object.assign(x,{color:null,object:null,index:-1})}},{key:"_resizeBuffer",value:function(){var gl=this.gl;this.pickingFBO||(this.pickingFBO=new _core.Framebuffer(gl),_core.Framebuffer.isSupported(gl,{colorBufferFloat:!0})&&(this.depthFBO=new _core.Framebuffer(gl),
this.depthFBO.attach((0,_defineProperty2["default"])({},36064,new _core.Texture2D(gl,{format:(0,_core.isWebGL2)(gl)?34836:6408,type:5126})))));this.pickingFBO.resize({width:gl.canvas.width,height:gl.canvas.height});this.depthFBO&&this.depthFBO.resize({width:gl.canvas.width,height:gl.canvas.height});return this.pickingFBO}},{key:"_getPickable",value:function(layers){layers=layers.filter(function(layer){return layer.isPickable()&&!layer.isComposite});return 255<layers.length?(_log["default"].warn("Too many pickable layers, only picking the first 255")(),
layers.slice(0,255)):layers}},{key:"_pickClosestObject",value:function(_ref2){var layers=_ref2.layers,viewports=_ref2.viewports,x=_ref2.x,y=_ref2.y,_ref2$radius=_ref2.radius,radius=void 0===_ref2$radius?0:_ref2$radius;_ref2$radius=_ref2.depth;_ref2$radius=void 0===_ref2$radius?1:_ref2$radius;var _ref2$mode=_ref2.mode;_ref2$mode=void 0===_ref2$mode?"query":_ref2$mode;var unproject3D=_ref2.unproject3D;_ref2=_ref2.onViewportActive;layers=this._getPickable(layers);this._resizeBuffer();var pixelRatio=
(0,_core.cssToDeviceRatio)(this.gl),devicePixelRange=(0,_core.cssToDevicePixels)(this.gl,[x,y],!0);devicePixelRange=[devicePixelRange.x+Math.floor(devicePixelRange.width/2),devicePixelRange.y+Math.floor(devicePixelRange.height/2)];radius=Math.round(radius*pixelRatio);var _this$pickingFBO=this.pickingFBO;_this$pickingFBO=this._getPickingRect({deviceX:devicePixelRange[0],deviceY:devicePixelRange[1],deviceRadius:radius,deviceWidth:_this$pickingFBO.width,deviceHeight:_this$pickingFBO.height});for(var infos,
result=[],affectedLayers={},i=0;i<_ref2$radius;i++){infos=_this$pickingFBO&&this._drawAndSample({layers:layers,viewports:viewports,onViewportActive:_ref2,deviceRect:_this$pickingFBO,pass:"picking:".concat(_ref2$mode),redrawReason:_ref2$mode});var pickInfo=(0,_queryObject.getClosestObject)({pickedColors:infos,layers:layers,deviceX:devicePixelRange[0],deviceY:devicePixelRange[1],deviceRadius:radius,deviceRect:_this$pickingFBO});infos=void 0;pickInfo.pickedLayer&&unproject3D&&this.depthFBO&&(infos=this._drawAndSample({layers:[pickInfo.pickedLayer],
viewports:viewports,onViewportActive:_ref2,deviceRect:{x:pickInfo.pickedX,y:pickInfo.pickedY,width:1,height:1},pass:"picking:".concat(_ref2$mode),redrawReason:"pick-z",pickZ:!0})[0]*viewports[0].distanceScales.metersPerUnit[2]+viewports[0].position[2]);if(pickInfo.pickedColor&&i+1<_ref2$radius){var layerId=pickInfo.pickedColor[3]-1;affectedLayers[layerId]=!0;layers[layerId].clearPickingColor(pickInfo.pickedColor)}infos=(0,_pickInfo.processPickInfo)({pickInfo:pickInfo,lastPickedInfo:this.lastPickedInfo,
mode:_ref2$mode,layers:layers,viewports:viewports,x:x,y:y,z:infos,pixelRatio:pixelRatio});layerId=!0;var _didIteratorError=!1,_iteratorError=void 0;try{for(var _iterator=infos.values()[Symbol.iterator](),_step;!(layerId=(_step=_iterator.next()).done);layerId=!0){var info=_step.value;info.layer&&result.push(info)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{if(!layerId&&null!=_iterator["return"])_iterator["return"]()}finally{if(_didIteratorError)throw _iteratorError;}}if(!pickInfo.pickedColor)break}for(var _layerId in affectedLayers)layers[_layerId].restorePickingColors();
return{result:result,emptyInfo:infos&&infos.get(null)}}},{key:"_pickVisibleObjects",value:function(_ref3){var layers=_ref3.layers,viewports=_ref3.viewports,x=_ref3.x,y=_ref3.y,_ref3$width=_ref3.width,width=void 0===_ref3$width?1:_ref3$width;_ref3$width=_ref3.height;var height=void 0===_ref3$width?1:_ref3$width;_ref3$width=_ref3.mode;var mode=void 0===_ref3$width?"query":_ref3$width;_ref3=_ref3.onViewportActive;layers=this._getPickable(layers);this._resizeBuffer();var pixelRatio=(0,_core.cssToDeviceRatio)(this.gl),
leftTop=(0,_core.cssToDevicePixels)(this.gl,[x,y],!0);_ref3$width=leftTop.x;leftTop=leftTop.y+leftTop.height;var rightBottom=(0,_core.cssToDevicePixels)(this.gl,[x+width,y+height],!0),deviceBottom=rightBottom.y;viewports=this._drawAndSample({layers:layers,viewports:viewports,onViewportActive:_ref3,deviceRect:{x:_ref3$width,y:deviceBottom,width:rightBottom.x+rightBottom.width-_ref3$width,height:leftTop-deviceBottom},pass:"picking:".concat(mode),redrawReason:mode});layers=(0,_queryObject.getUniqueObjects)({pickedColors:viewports,
layers:layers});var uniqueInfos=new Map;layers.forEach(function(pickInfo){var info={color:pickInfo.pickedColor,layer:null,index:pickInfo.pickedObjectIndex,picked:!0,x:x,y:y,width:width,height:height,pixelRatio:pixelRatio};info=(0,_pickInfo.getLayerPickingInfo)({layer:pickInfo.pickedLayer,info:info,mode:mode});uniqueInfos.has(info.object)||uniqueInfos.set(info.object,info)});return Array.from(uniqueInfos.values())}},{key:"_drawAndSample",value:function(_ref4){var layers=_ref4.layers,viewports=_ref4.viewports,
onViewportActive=_ref4.onViewportActive,deviceRect=_ref4.deviceRect,pass=_ref4.pass,redrawReason=_ref4.redrawReason,pickZ=_ref4.pickZ;(0,_assert["default"])(0<deviceRect.width&&0<deviceRect.height);if(1>layers.length)return null;_ref4=pickZ?this.depthFBO:this.pickingFBO;this.pickLayersPass.render({layers:layers,layerFilter:this.layerFilter,onError:this._onError,viewports:viewports,onViewportActive:onViewportActive,pickingFBO:_ref4,deviceRect:deviceRect,pass:pass,redrawReason:redrawReason,pickZ:pickZ});
layers=deviceRect.x;viewports=deviceRect.y;onViewportActive=deviceRect.width;deviceRect=deviceRect.height;pickZ=new (pickZ?Float32Array:Uint8Array)(onViewportActive*deviceRect*4);(0,_core.readPixelsToArray)(_ref4,{sourceX:layers,sourceY:viewports,sourceWidth:onViewportActive,sourceHeight:deviceRect,target:pickZ});return pickZ}},{key:"_getPickingRect",value:function(_ref5){var deviceX=_ref5.deviceX,deviceY=_ref5.deviceY,deviceRadius=_ref5.deviceRadius,x=Math.max(0,deviceX-deviceRadius),y=Math.max(0,
deviceY-deviceRadius);deviceX=Math.min(_ref5.deviceWidth,deviceX+deviceRadius+1)-x;_ref5=Math.min(_ref5.deviceHeight,deviceY+deviceRadius+1)-y;return 0>=deviceX||0>=_ref5?null:{x:x,y:y,width:deviceX,height:_ref5}}}]);return DeckPicker}();exports["default"]=require}
//# sourceMappingURL=module$node_modules$$deck_DOT_gl$core$dist$es5$lib$deck_picker.js.map
