shadow$provide.module$node_modules$$deck_DOT_gl$mesh_layers$dist$es5$scenegraph_layer$scenegraph_layer=function(global,require,module,exports){global=require("module$node_modules$$babel$runtime$helpers$interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0});exports["default"]=void 0;var _classCallCheck2=global(require("module$node_modules$$babel$runtime$helpers$classCallCheck")),_createClass2=global(require("module$node_modules$$babel$runtime$helpers$createClass")),_possibleConstructorReturn2=
global(require("module$node_modules$$babel$runtime$helpers$possibleConstructorReturn")),_getPrototypeOf2=global(require("module$node_modules$$babel$runtime$helpers$getPrototypeOf")),_get2=global(require("module$node_modules$$babel$runtime$helpers$get")),_inherits2=global(require("module$node_modules$$babel$runtime$helpers$inherits")),_typeof2=global(require("module$node_modules$$babel$runtime$helpers$typeof")),_core=require("module$node_modules$$deck_DOT_gl$core$dist$es5$index"),_core2=require("module$node_modules$$luma_DOT_gl$core$dist$es5$index"),
_shadertools=require("module$node_modules$$luma_DOT_gl$shadertools$dist$es5$index"),_experimental=require("module$node_modules$$luma_DOT_gl$experimental$dist$es5$index"),_gltfUtils=require("module$node_modules$$deck_DOT_gl$mesh_layers$dist$es5$scenegraph_layer$gltf_utils"),_matrix=require("module$node_modules$$deck_DOT_gl$mesh_layers$dist$es5$utils$matrix"),_scenegraphLayerVertex=global(require("module$node_modules$$deck_DOT_gl$mesh_layers$dist$es5$scenegraph_layer$scenegraph_layer_vertex_glsl")),
_scenegraphLayerFragment=global(require("module$node_modules$$deck_DOT_gl$mesh_layers$dist$es5$scenegraph_layer$scenegraph_layer_fragment_glsl")),DEFAULT_COLOR=[255,255,255,255];require={scenegraph:{type:"object",value:null,async:!0},getScene:function(gltf){return gltf&&gltf.scenes?"object"===(0,_typeof2["default"])(gltf.scene)?gltf.scene:gltf.scenes[gltf.scene||0]:gltf},getAnimator:function(scenegraph){return scenegraph&&scenegraph.animator},_animations:null,sizeScale:{type:"number",value:1,min:0},
sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},getPosition:{type:"accessor",value:function(x){return x.position}},getColor:{type:"accessor",value:DEFAULT_COLOR},_lighting:"flat",_imageBasedLightingEnvironment:null,getOrientation:{type:"accessor",value:[0,0,0]},getScale:{type:"accessor",value:[1,1,1]},getTranslation:{type:"accessor",value:[0,0,0]},getTransformMatrix:{type:"accessor",value:[]}};global=function(_Layer){function ScenegraphLayer(){(0,
_classCallCheck2["default"])(this,ScenegraphLayer);return(0,_possibleConstructorReturn2["default"])(this,(0,_getPrototypeOf2["default"])(ScenegraphLayer).apply(this,arguments))}(0,_inherits2["default"])(ScenegraphLayer,_Layer);(0,_createClass2["default"])(ScenegraphLayer,[{key:"initializeState",value:function(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),accessor:"getPosition",transition:!0},instanceColors:{type:5121,size:this.props.colorFormat.length,
accessor:"getColor",normalized:!0,defaultValue:DEFAULT_COLOR,transition:!0},instanceModelMatrix:_matrix.MATRIX_ATTRIBUTES})}},{key:"updateState",value:function(params){(0,_get2["default"])((0,_getPrototypeOf2["default"])(ScenegraphLayer.prototype),"updateState",this).call(this,params);var props=params.props;params=params.oldProps;props.scenegraph!==params.scenegraph?this._updateScenegraph(props):props._animations!==params._animations&&this._applyAnimationsProp(this.state.scenegraph,this.state.animator,
props._animations)}},{key:"finalizeState",value:function(){(0,_get2["default"])((0,_getPrototypeOf2["default"])(ScenegraphLayer.prototype),"finalizeState",this).call(this);this._deleteScenegraph()}},{key:"_updateScenegraph",value:function(props){var _this=this,gl=this.context.gl;if(props.scenegraph instanceof _experimental.ScenegraphNode)var scenegraphData={scenes:[props.scenegraph]};else if(props.scenegraph&&!props.scenegraph.gltf){scenegraphData=props.scenegraph;var gltfObjects=(0,_experimental.createGLTFObjects)(gl,
scenegraphData,this.getLoadOptions());scenegraphData=Object.assign({gltf:scenegraphData},gltfObjects);(0,_gltfUtils.waitForGLTFAssets)(gltfObjects).then(function(){return _this.setNeedsRedraw()})}else _core.log.deprecated("ScenegraphLayer.props.scenegraph","Use GLTFLoader instead of GLTFScenegraphLoader")(),scenegraphData=props.scenegraph;gltfObjects={layer:this,gl:gl};gl=props.getScene(scenegraphData,gltfObjects);scenegraphData=props.getAnimator(scenegraphData,gltfObjects);gl instanceof _experimental.ScenegraphNode?
(this._deleteScenegraph(),this._applyAllAttributes(gl),this._applyAnimationsProp(gl,scenegraphData,props._animations),this.setState({scenegraph:gl,animator:scenegraphData})):null!==gl&&_core.log.warn("invalid scenegraph:",gl)()}},{key:"_applyAllAttributes",value:function(scenegraph){var _this2=this;if(this.state.attributesAvailable){var allAttributes=this.getAttributeManager().getAttributes();scenegraph.traverse(function(model){_this2._setModelAttributes(model.model,allAttributes)})}}},{key:"_applyAnimationsProp",
value:function(scenegraph,animator,animationsProp){if(scenegraph&&animator&&animationsProp){var animations=animator.getAnimations();Object.keys(animationsProp).sort().forEach(function(key){var value=animationsProp[key];if("*"===key)animations.forEach(function(animation){Object.assign(animation,value)});else if(Number.isFinite(Number(key))){var number=Number(key);0<=number&&number<animations.length?Object.assign(animations[number],value):_core.log.warn("animation ".concat(key," not found"))()}else(number=
animations.find(function(_ref){return _ref.name===key}))?Object.assign(number,value):_core.log.warn("animation ".concat(key," not found"))()})}}},{key:"_deleteScenegraph",value:function(){var scenegraph=this.state.scenegraph;if(scenegraph instanceof _experimental.ScenegraphNode)scenegraph["delete"]()}},{key:"getLoadOptions",value:function(){var modules=[_core.project32,_core.picking],_this$props=this.props,_imageBasedLightingEnvironment=_this$props._imageBasedLightingEnvironment;"pbr"===_this$props._lighting&&
modules.push(_shadertools.pbr);_this$props=null;_imageBasedLightingEnvironment&&(_this$props="function"===typeof _imageBasedLightingEnvironment?_imageBasedLightingEnvironment({gl:this.context.gl,layer:this}):_imageBasedLightingEnvironment);return{gl:this.context.gl,waitForFullLoad:!0,imageBasedLightingEnvironment:_this$props,modelOptions:{vs:_scenegraphLayerVertex["default"],fs:_scenegraphLayerFragment["default"],modules:modules,isInstanced:!0,transpileToGLSL100:!(0,_core2.isWebGL2)(this.context.gl)},
useTangents:!1}}},{key:"updateAttributes",value:function(changedAttributes){var _this3=this;this.setState({attributesAvailable:!0});this.state.scenegraph&&this.state.scenegraph.traverse(function(model){_this3._setModelAttributes(model.model,changedAttributes)})}},{key:"draw",value:function(_ref2){var _ref2$moduleParameter=_ref2.moduleParameters,moduleParameters=void 0===_ref2$moduleParameter?null:_ref2$moduleParameter;_ref2$moduleParameter=_ref2.parameters;var parameters=void 0===_ref2$moduleParameter?
{}:_ref2$moduleParameter;_ref2=_ref2.context;if(this.state.scenegraph){this.props._animations&&this.state.animator&&this.state.animator.animate(_ref2.animationProps.time);var viewport=this.context.viewport;_ref2=this.props;var sizeScale=_ref2.sizeScale,sizeMinPixels=_ref2.sizeMinPixels,sizeMaxPixels=_ref2.sizeMaxPixels,opacity=_ref2.opacity,coordinateSystem=_ref2.coordinateSystem,numInstances=this.getNumInstances();this.state.scenegraph.traverse(function(model,_ref3){_ref3=_ref3.worldMatrix;model.model.setInstanceCount(numInstances);
model.updateModuleSettings(moduleParameters);model.draw({parameters:parameters,uniforms:{sizeScale:sizeScale,opacity:opacity,sizeMinPixels:sizeMinPixels,sizeMaxPixels:sizeMaxPixels,composeModelMatrix:(0,_matrix.shouldComposeModelMatrix)(viewport,coordinateSystem),sceneModelMatrix:_ref3,u_Camera:model.model.getUniforms().project_uCameraPosition}})})}}}]);return ScenegraphLayer}(_core.Layer);exports["default"]=global;global.layerName="ScenegraphLayer";global.defaultProps=require}
//# sourceMappingURL=module$node_modules$$deck_DOT_gl$mesh_layers$dist$es5$scenegraph_layer$scenegraph_layer.js.map
