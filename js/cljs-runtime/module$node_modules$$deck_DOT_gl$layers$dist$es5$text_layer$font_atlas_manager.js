shadow$provide.module$node_modules$$deck_DOT_gl$layers$dist$es5$text_layer$font_atlas_manager=function(global,require,module,exports){function getNewChars(key,characterSet){key=cache.get(key);if(!key)return characterSet;var newChars=[],cachedCharSet=Object.keys(key.mapping);cachedCharSet=new Set(cachedCharSet);characterSet instanceof Array&&(characterSet=new Set(characterSet));characterSet.forEach(function(_char){cachedCharSet.has(_char)||newChars.push(_char)});return newChars}function populateAlphaChannel(alphaChannel,
imageData){for(var i=0;i<alphaChannel.length;i++)imageData.data[4*i+3]=alphaChannel[i]}function setTextStyle(ctx,fontFamily,fontSize,fontWeight){ctx.font="".concat(fontWeight," ").concat(fontSize,"px ").concat(fontFamily);ctx.fillStyle="#000";ctx.textBaseline="baseline";ctx.textAlign="left"}global=require("module$node_modules$$babel$runtime$helpers$interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0});exports["default"]=exports.DEFAULT_RADIUS=exports.DEFAULT_CUTOFF=exports.DEFAULT_BUFFER=
exports.DEFAULT_FONT_SIZE=exports.DEFAULT_FONT_WEIGHT=exports.DEFAULT_FONT_FAMILY=exports.DEFAULT_CHAR_SET=void 0;var _defineProperty2=global(require("module$node_modules$$babel$runtime$helpers$defineProperty")),_classCallCheck2=global(require("module$node_modules$$babel$runtime$helpers$classCallCheck")),_createClass2=global(require("module$node_modules$$babel$runtime$helpers$createClass")),_core=require("module$node_modules$$luma_DOT_gl$core$dist$es5$index"),_tinySdf=global(require("module$node_modules$$mapbox$tiny_sdf$index")),
_utils=require("module$node_modules$$deck_DOT_gl$layers$dist$es5$text_layer$utils");require=global(require("module$node_modules$$deck_DOT_gl$layers$dist$es5$text_layer$lru_cache"));var DEFAULT_CHAR_SET=function(){for(var charSet=[],i=32;128>i;i++)charSet.push(String.fromCharCode(i));return charSet}();exports.DEFAULT_CHAR_SET=DEFAULT_CHAR_SET;exports.DEFAULT_FONT_FAMILY="Monaco, monospace";exports.DEFAULT_FONT_WEIGHT="normal";exports.DEFAULT_FONT_SIZE=64;exports.DEFAULT_BUFFER=2;exports.DEFAULT_CUTOFF=
.25;exports.DEFAULT_RADIUS=3;var cache=new require["default"](3),VALID_PROPS="fontFamily fontWeight characterSet fontSize sdf buffer cutoff radius".split(" ");require=function(){function FontAtlasManager(gl){(0,_classCallCheck2["default"])(this,FontAtlasManager);this.gl=gl;this.props={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:DEFAULT_CHAR_SET,fontSize:64,buffer:2,sdf:!1,cutoff:.25,radius:3};this._key=null;this._texture=new _core.Texture2D(this.gl)}(0,_createClass2["default"])(FontAtlasManager,
[{key:"finalize",value:function(){this._texture["delete"]()}},{key:"setProps",value:function(){var _this=this,props=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};VALID_PROPS.forEach(function(prop){prop in props&&(_this.props[prop]=props[prop])});var oldKey=this._key;this._key=this._getKey();var charSet=getNewChars(this._key,this.props.characterSet),cachedFontAtlas=cache.get(this._key);cachedFontAtlas&&0===charSet.length?this._key!==oldKey&&this._updateTexture(cachedFontAtlas):(oldKey=
this._generateFontAtlas(this._key,charSet,cachedFontAtlas),this._updateTexture(oldKey),cache.set(this._key,oldKey))}},{key:"_updateTexture",value:function(_ref){var _parameters,canvas=_ref.data,width=_ref.width;_ref=_ref.height;this._texture.width===width&&this._texture.height===_ref||this._texture.resize({width:width,height:_ref});this._texture.setImageData({data:canvas,width:width,height:_ref,parameters:(_parameters={},(0,_defineProperty2["default"])(_parameters,10242,33071),(0,_defineProperty2["default"])(_parameters,
10243,33071),_parameters)});this._texture.generateMipmap()}},{key:"_generateFontAtlas",value:function(key,characterSet,cachedFontAtlas){key=this.props;var fontFamily=key.fontFamily,fontWeight=key.fontWeight,fontSize=key.fontSize,buffer=key.buffer,sdf=key.sdf,radius=key.radius,cutoff=key.cutoff;key=cachedFontAtlas&&cachedFontAtlas.data;key||(key=document.createElement("canvas"),key.width=1024);var ctx=key.getContext("2d");setTextStyle(ctx,fontFamily,fontSize,fontWeight);var _buildMapping=(0,_utils.buildMapping)(Object.assign({getFontWidth:function(_char2){return ctx.measureText(_char2).width},
fontHeight:1.2*fontSize,buffer:buffer,characterSet:characterSet,maxCanvasWidth:1024},cachedFontAtlas&&{mapping:cachedFontAtlas.mapping,xOffset:cachedFontAtlas.xOffset,yOffset:cachedFontAtlas.yOffset}));cachedFontAtlas=_buildMapping.mapping;var canvasHeight=_buildMapping.canvasHeight,xOffset=_buildMapping.xOffset;_buildMapping=_buildMapping.yOffset;if(key.height!==canvasHeight){var imageData=ctx.getImageData(0,0,key.width,key.height);key.height=canvasHeight;ctx.putImageData(imageData,0,0)}setTextStyle(ctx,
fontFamily,fontSize,fontWeight);if(sdf){var tinySDF=new _tinySdf["default"](fontSize,buffer,radius,cutoff,fontFamily,fontWeight),_imageData=ctx.getImageData(0,0,tinySDF.size,tinySDF.size),_iteratorNormalCompletion=!0;fontSize=!1;fontFamily=void 0;try{for(var _iterator=characterSet[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var _char3=_step.value;populateAlphaChannel(tinySDF.draw(_char3),_imageData);ctx.putImageData(_imageData,
cachedFontAtlas[_char3].x-buffer,cachedFontAtlas[_char3].y-buffer)}}catch(err){fontSize=!0,fontFamily=err}finally{try{if(!_iteratorNormalCompletion&&null!=_iterator["return"])_iterator["return"]()}finally{if(fontSize)throw fontFamily;}}}else{_iterator=!0;_step=!1;_char3=void 0;try{for(tinySDF=characterSet[Symbol.iterator]();!(_iterator=(_imageData=tinySDF.next()).done);_iterator=!0)_iteratorNormalCompletion=_imageData.value,ctx.fillText(_iteratorNormalCompletion,cachedFontAtlas[_iteratorNormalCompletion].x,
cachedFontAtlas[_iteratorNormalCompletion].y+.9*fontSize)}catch(err$422){_step=!0,_char3=err$422}finally{try{if(!_iterator&&null!=tinySDF["return"])tinySDF["return"]()}finally{if(_step)throw _char3;}}}return{xOffset:xOffset,yOffset:_buildMapping,mapping:cachedFontAtlas,data:key,width:key.width,height:key.height}}},{key:"_getKey",value:function(){var _this$props2=this.props,gl=_this$props2.gl,fontFamily=_this$props2.fontFamily,fontWeight=_this$props2.fontWeight,fontSize=_this$props2.fontSize,buffer=
_this$props2.buffer,radius=_this$props2.radius,cutoff=_this$props2.cutoff;return _this$props2.sdf?"".concat(gl," ").concat(fontFamily," ").concat(fontWeight," ").concat(fontSize," ").concat(buffer," ").concat(radius," ").concat(cutoff):"".concat(gl," ").concat(fontFamily," ").concat(fontWeight," ").concat(fontSize," ").concat(buffer)}},{key:"texture",get:function(){return this._texture}},{key:"mapping",get:function(){var data=cache.get(this._key);return data&&data.mapping}},{key:"scale",get:function(){return 1.2}}]);
return FontAtlasManager}();exports["default"]=require}
//# sourceMappingURL=module$node_modules$$deck_DOT_gl$layers$dist$es5$text_layer$font_atlas_manager.js.map
