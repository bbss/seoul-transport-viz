shadow$provide.module$node_modules$$deck_DOT_gl$geo_layers$dist$es5$tile_layer$tileset_2d=function(global,require,module,exports){function getPlaceholderInChildren(tile){var _iteratorNormalCompletion9=!0,_didIteratorError9=!1,_iteratorError9=void 0;try{for(var _iterator9=tile.children[Symbol.iterator](),_step9;!(_iteratorNormalCompletion9=(_step9=_iterator9.next()).done);_iteratorNormalCompletion9=!0){var child=_step9.value;child.state=Math.max(child.state,3);child.isLoaded||getPlaceholderInChildren(child)}}catch(err){_didIteratorError9=
!0,_iteratorError9=err}finally{try{if(!_iteratorNormalCompletion9&&null!=_iterator9["return"])_iterator9["return"]()}finally{if(_didIteratorError9)throw _iteratorError9;}}}global=require("module$node_modules$$babel$runtime$helpers$interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0});exports["default"]=exports.STRATEGY_DEFAULT=exports.STRATEGY_REPLACE=exports.STRATEGY_NEVER=void 0;var _slicedToArray2=global(require("module$node_modules$$babel$runtime$helpers$slicedToArray")),
_classCallCheck2=global(require("module$node_modules$$babel$runtime$helpers$classCallCheck")),_createClass2=global(require("module$node_modules$$babel$runtime$helpers$createClass")),_tile2dHeader=global(require("module$node_modules$$deck_DOT_gl$geo_layers$dist$es5$tile_layer$tile_2d_header")),_utils=require("module$node_modules$$deck_DOT_gl$geo_layers$dist$es5$tile_layer$utils"),_loaderUtils=require("module$node_modules$$loaders_DOT_gl$loader_utils$dist$es5$index");exports.STRATEGY_NEVER="never";
exports.STRATEGY_REPLACE="no-overlap";exports.STRATEGY_DEFAULT="best-available";require=function(){function Tileset2D(opts){var _this=this;(0,_classCallCheck2["default"])(this,Tileset2D);this.opts=opts;this._getTileData=opts.getTileData;this.onTileError=opts.onTileError;this.onTileLoad=function(tile){opts.onTileLoad(tile);_this.opts.maxCacheByteSize&&(_this._cacheByteSize+=tile.byteLength,_this._resizeCache())};this._requestScheduler=new _loaderUtils.RequestScheduler({maxRequests:opts.maxRequests,
throttleRequests:opts.throttleRequests&&0<opts.maxRequests});this._cache=new Map;this._tiles=[];this._dirty=!1;this._cacheByteSize=0;this._selectedTiles=this._viewport=null;this._frameNumber=0;this.setOptions(opts)}(0,_createClass2["default"])(Tileset2D,[{key:"setOptions",value:function(opts){Object.assign(this.opts,opts);Number.isFinite(opts.maxZoom)&&(this._maxZoom=Math.floor(opts.maxZoom));Number.isFinite(opts.minZoom)&&(this._minZoom=Math.ceil(opts.minZoom))}},{key:"update",value:function(viewport){var _this2=
this,zRange=(1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}).zRange;viewport.equals(this._viewport)||(this._viewport=viewport,this._selectedTiles=this.getTileIndices({viewport:viewport,maxZoom:this._maxZoom,minZoom:this._minZoom,zRange:zRange}).map(function(index){return _this2._getTile(index,!0)}),this._dirty&&this._rebuildTree());zRange=this.updateTileStates();this._dirty&&this._resizeCache();zRange&&this._frameNumber++;return this._frameNumber}},{key:"getTileIndices",value:function(_ref2){var viewport=
_ref2.viewport,maxZoom=_ref2.maxZoom,minZoom=_ref2.minZoom;_ref2=_ref2.zRange;var _this$opts=this.opts,tileSize=_this$opts.tileSize;_this$opts=_this$opts.extent;return(0,_utils.getTileIndices)({viewport:viewport,maxZoom:maxZoom,minZoom:minZoom,zRange:_ref2,tileSize:tileSize,extent:_this$opts})}},{key:"getTileMetadata",value:function(_ref3){var x=_ref3.x,y=_ref3.y;_ref3=_ref3.z;return{bbox:(0,_utils.tileToBoundingBox)(this._viewport,x,y,_ref3)}}},{key:"getParentIndex",value:function(tileIndex){tileIndex.x=
Math.floor(tileIndex.x/2);tileIndex.y=Math.floor(tileIndex.y/2);--tileIndex.z;return tileIndex}},{key:"updateTileStates",value:function(){this._updateTileStates(this.selectedTiles);var changed=!1,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _iterator=this._cache.values()[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var tile=_step.value,isVisible=!!(tile.state&1);tile.isVisible!==isVisible&&
(changed=!0,tile.isVisible=isVisible);tile.isSelected=5===tile.state}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&null!=_iterator["return"])_iterator["return"]()}finally{if(_didIteratorError)throw _iteratorError;}}return changed}},{key:"_rebuildTree",value:function(){var _cache=this._cache,_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _iterator2=_cache.values()[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=
(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var tile=_step2.value;tile.parent=null;tile.children.length=0}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&null!=_iterator2["return"])_iterator2["return"]()}finally{if(_didIteratorError2)throw _iteratorError2;}}_iteratorNormalCompletion2=!0;_didIteratorError2=!1;_iteratorError2=void 0;try{for(var _iterator3=_cache.values()[Symbol.iterator](),_step3;!(_iteratorNormalCompletion2=(_step3=
_iterator3.next()).done);_iteratorNormalCompletion2=!0){var _tile=_step3.value,parent=this._getNearestAncestor(_tile.x,_tile.y,_tile.z);(_tile.parent=parent)&&parent.children.push(_tile)}}catch(err$401){_didIteratorError2=!0,_iteratorError2=err$401}finally{try{if(!_iteratorNormalCompletion2&&null!=_iterator3["return"])_iterator3["return"]()}finally{if(_didIteratorError2)throw _iteratorError2;}}}},{key:"_updateTileStates",value:function(selectedTiles){var _cache=this._cache,refinementStrategy=this.opts.refinementStrategy||
"best-available",_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _iterator4=_cache.values()[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0)_step4.value.state=0}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&null!=_iterator4["return"])_iterator4["return"]()}finally{if(_didIteratorError4)throw _iteratorError4;}}_cache=!0;_iteratorNormalCompletion4=
!1;_didIteratorError4=void 0;try{for(var _iterator5=selectedTiles[Symbol.iterator](),_step5;!(_cache=(_step5=_iterator5.next()).done);_cache=!0)_step5.value.state=5}catch(err$402){_iteratorNormalCompletion4=!0,_didIteratorError4=err$402}finally{try{if(!_cache&&null!=_iterator5["return"])_iterator5["return"]()}finally{if(_iteratorNormalCompletion4)throw _didIteratorError4;}}if("never"!==refinementStrategy){_iterator5=!0;_step5=!1;_cache=void 0;try{for(var _iterator6=selectedTiles[Symbol.iterator](),
_step6;!(_iterator5=(_step6=_iterator6.next()).done);_iterator5=!0)a:{_iteratorNormalCompletion4=void 0;var tile=_step6.value;_didIteratorError4=refinementStrategy;for(_iteratorError4=3;_iteratorNormalCompletion4=tile.parent;){if(tile.isLoaded&&(_iteratorError4=4,"best-available"===_didIteratorError4))break a;_iteratorNormalCompletion4.state=Math.max(_iteratorNormalCompletion4.state,_iteratorError4);tile=_iteratorNormalCompletion4}}}catch(err$403){_step5=!0,_cache=err$403}finally{try{if(!_iterator5&&
null!=_iterator6["return"])_iterator6["return"]()}finally{if(_step5)throw _cache;}}refinementStrategy=!0;_iterator6=!1;_step6=void 0;try{for(var _iterator7=selectedTiles[Symbol.iterator](),_step7;!(refinementStrategy=(_step7=_iterator7.next()).done);refinementStrategy=!0){var _tile4=_step7.value;a:{for(selectedTiles=_tile4;selectedTiles;){if(selectedTiles.state&0){var JSCompiler_inline_result=!0;break a}if(selectedTiles.isLoaded){JSCompiler_inline_result=!1;break a}selectedTiles=selectedTiles.parent}JSCompiler_inline_result=
!0}JSCompiler_inline_result&&getPlaceholderInChildren(_tile4)}}catch(err$404){_iterator6=!0,_step6=err$404}finally{try{if(!refinementStrategy&&null!=_iterator7["return"])_iterator7["return"]()}finally{if(_iterator6)throw _step6;}}}}},{key:"_resizeCache",value:function(){var _cache=this._cache,opts=this.opts,maxCacheSize=opts.maxCacheSize||(opts.maxCacheByteSize?Infinity:5*this.selectedTiles.length),maxCacheByteSize=opts.maxCacheByteSize||Infinity;if(_cache.size>maxCacheSize||this._cacheByteSize>maxCacheByteSize){var _iteratorNormalCompletion8=
!0,_didIteratorError8=!1,_iteratorError8=void 0;try{for(var _iterator8=_cache[Symbol.iterator](),_step8;!(_iteratorNormalCompletion8=(_step8=_iterator8.next()).done);_iteratorNormalCompletion8=!0){var _step8$value=(0,_slicedToArray2["default"])(_step8.value,2),tileId=_step8$value[0],tile=_step8$value[1];tile.isVisible||(this._cacheByteSize-=opts.maxCacheByteSize?tile.byteLength:0,_cache["delete"](tileId));if(_cache.size<=maxCacheSize&&this._cacheByteSize<=maxCacheByteSize)break}}catch(err){_didIteratorError8=
!0,_iteratorError8=err}finally{try{if(!_iteratorNormalCompletion8&&null!=_iterator8["return"])_iterator8["return"]()}finally{if(_didIteratorError8)throw _iteratorError8;}}this._rebuildTree();this._dirty=!0}this._dirty&&(this._tiles=Array.from(this._cache.values()).sort(function(t1,t2){return t1.z-t2.z}),this._dirty=!1)}},{key:"_getTile",value:function(_ref4,create){var x=_ref4.x,y=_ref4.y;_ref4=_ref4.z;var tileId="".concat(x,",").concat(y,",").concat(_ref4),tile=this._cache.get(tileId);!tile&&create?
(tile=new _tile2dHeader["default"]({x:x,y:y,z:_ref4,onTileLoad:this.onTileLoad,onTileError:this.onTileError}),Object.assign(tile,this.getTileMetadata(tile)),tile.loadData(this._getTileData,this._requestScheduler),this._cache.set(tileId,tile),this._dirty=!0):tile&&tile.isCancelled&&tile.loadData(this._getTileData,this._requestScheduler);return tile}},{key:"_getNearestAncestor",value:function(x,y,z){var _this$_minZoom=this._minZoom;_this$_minZoom=void 0===_this$_minZoom?0:_this$_minZoom;for(x={x:x,
y:y,z:z};x.z>_this$_minZoom;)if(x=this.getParentIndex(x),y=this._getTile(x))return y;return null}},{key:"tiles",get:function(){return this._tiles}},{key:"selectedTiles",get:function(){return this._selectedTiles}},{key:"isLoaded",get:function(){return this._selectedTiles.every(function(tile){return tile.isLoaded})}}]);return Tileset2D}();exports["default"]=require}
//# sourceMappingURL=module$node_modules$$deck_DOT_gl$geo_layers$dist$es5$tile_layer$tileset_2d.js.map
